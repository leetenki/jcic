<style type="text/css">
  table {
    margin: 30px 0;
  }
  td, th {
    border: 1px solid #cccccc;
    padding: 5px;
    text-align: center
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>


<% analysis_period = 30 #days %>
<% if !params[:mode] %>
  <% params[:mode] = "total" %>
<% end %>
<h1><i class="fa fa-signal"></i> 数据分析</h1>
<div class="row">
  <div class="container col-md-12">
    <table class="col-md-12">
      <thead>
        <tr>
          <td colspan="2" style="text-align:right;">
            <div data-toggle="buttons" style="margin-top:0; margin:5px;" class="btn-group toggle">
              <label class="btn btn-default <%= 'active' if (params[:mode] == 'total') %>" onclick="location.href='/admin/anylisis?mode=total'">
                全種
              </label>
              <label class="btn btn-default <%= 'active' if params[:mode] == 'seperate' %>" onclick="location.href='/admin/anylisis?mode=seperate'">
                分別
              </label>
            </div>            
          </td>
        </tr>
      </thead>
      <% @traders.order("id desc").reverse.each do |trader| %>
        <tr>
          <td style="width: 25%">
            <div style="font-weight: bolder; color: #888888; text-align: left;">
              <% if trader.id == 1 %>
                合計
              <% else %>
                <%= trader.company_name %>
              <% end %>
            </div>
          </td>
          <td class="graph-cell" style="width: 75%">
            <% labels = "[" %>
            <% if params[:mode] == "seperate" %>
              <% group = "[" %>
              <% individual = "[" %>
            <% else %>
              <% data = "[" %>
            <% end %>

            <% (analysis_period).downto(0).each do |num| %>
              <% target_date = Date.today - num %>
              <% labels += '"' + target_date.strftime("%m月%d日") + '"' %>
              <% if trader.id == 1 %>
                <% projects = Project.where(:created_at => Time.parse(target_date.strftime("%Y-%m-%d"))..Time.parse(target_date.strftime("%Y-%m-%d"))+60*60*24-1, :status => "committed", :delete_request => false) %>
              <% else %>
                <% projects = Project.where(:created_at => Time.parse(target_date.strftime("%Y-%m-%d"))..Time.parse(target_date.strftime("%Y-%m-%d"))+60*60*24-1, :trader_id => trader.slave_trader_ids + [trader.id], :status => "committed", :delete_request => false) %>
              <% end %>
              <% if params[:mode] == "seperate" %>
                <% group_projects = projects.where(:visa_type => "group") %>
                <% group += group_projects.length.to_s %>
                <% individual += (projects.length-group_projects.length).to_s %>
              <% else %>
                <% data += projects.length.to_s %>
              <% end %>

              <% if num > 0 %>
                <% labels += "," %>

                <% if params[:mode] == "seperate" %>                
                  <% group += "," %>
                  <% individual += "," %>
                <% else %>
                  <% data += "," %>
                <% end %>
              <% end %>
            <% end %>

            <% labels += "]" %>
            <% if params[:mode] == "seperate" %>
              <% group += "]" %>
              <% individual += "]" %>
            <% else %>
              <% data += "]" %>
            <% end %>

            <input type="hidden" class="data" value="<%= data %>">
            <input type="hidden" class="group" value="<%= group %>">
            <input type="hidden" class="individual" value="<%= individual %>">
            <input type="hidden" class="labels" value="<%= labels %>">
            <div class="box">
              <canvas class="chart" height="100" width="600"></canvas>
            </div>
          </td>
        </tr>
      <% end %>
    </table>
  </div>
</div>

<script language="JavaScript">
  $("td.graph-cell").each(function() {
      var labels = JSON.parse($(this).find("input.labels")[0].value);
      <% if params[:mode] == "seperate" %>
        var group = JSON.parse($(this).find("input.group")[0].value);
        var individual = JSON.parse($(this).find("input.individual")[0].value);
      <% else %>
        var data = JSON.parse($(this).find("input.data")[0].value);
      <% end %>

      // orange 255,200,100,
      // gray 220,220,220,
      // green 80,200,180,
      // blue 151,187,205,
      var data = {
          labels: labels,
          datasets: [
          <% if params[:mode] == "seperate" %>
              {
                  label: "个签",
                  fillColor : "rgba(220,220,220,0.1)",//面の色・透明度
                  strokeColor : "rgba(220,220,220,1)",//線の色・透明度
                  pointColor : "rgba(220,220,220,1)", //点の色・透明度
                  pointStrokeColor: "#fff",
                  pointHighlightFill: "#fff",
                  pointHighlightStroke: "rgba(220,220,220,1)",
                  data: individual
              },
              {
                  label: "团签",
                  fillColor: "rgba(80,200,180,0.2)",
                  strokeColor: "rgba(80,200,180,1)",
                  pointColor: "rgba(80,200,180,1)",
                  pointStrokeColor: "#fff",
                  pointHighlightFill: "#fff",
                  pointHighlightStroke: "rgba(80,200,180,1)",
                  data: group
              }
          <% else %>
              {
                  label: "总数",
                  fillColor: "rgba(151,187,205,0.2)",
                  strokeColor: "rgba(151,187,205,1)",
                  pointColor: "rgba(151,187,205,1)",
                  pointStrokeColor: "#fff",
                  pointHighlightFill: "#fff",
                  pointHighlightStroke: "rgba(151,187,205,1)",
                  data: data
              }
          <% end %>
          ]
      };

      var options = {
        scaleLabel : "\<\%=value\%\>件",
        animationSteps : 10,
        tooltipFillColor: "rgba(0,0,0,0.8)",                
        tooltipTemplate: "\<\%if (label){\%\>\<\%=label\%\>: \<\%}\%\>\<\%= value \%\>件",
        multiTooltipTemplate: "\<\%=datasetLabel\%\>: \<\%= value \%\>件",
      };
      var ctx = $(this).find("canvas.chart")[0].getContext("2d")
      var lineChart = new Chart(ctx).Line(data, options);
  })

</script>